# Making the system bootable

## fstab

From outside chroot, run `scripts/config/genfstab.sh`, and redirect to `$LFS/etc/fstab`

Note: this gets the uuid (but that does not work from inside chroot) and use that to build the fstab entries

## Linux

### setup

Use `scripts/kernel/linux-setup.sh` to extract sources and clean, and setup a default config. Note this starts bash in the extracted directory

### configure

Configure using the menu `make menuconfig`

See the note about required options. See also note about options for UEFI support  
partial check: `scripts/kernel/check-kernel-config`

### build

`time make --jobs 8`

Time: 2.5x real (user+sys: 17.8x)

### install

Use `scripts/kernel/install-linux.sh <kernal name, preferably something with lfs>`

### No need to remove the sources

But need to chown: `chown -R 0:0 .`


## GRUB

`/boot/grub/grub.cfg` is generated by `grub-mkconfig`, so rather make changes in `/etc/grub.d/` files, and use `grub-mkconfig`, even though it is not recommended by the book: when dual booting another Linux system, updates to it will overwrite the configs in any case, so rather use it

### create LFS-specific menu entries

Do this even when using the host's boot partition

From inside chroot, output `scripts/config/gengrub.sh` to `/etc/grub.d/11_lfs` and make it executable:

```
mkdir -pv /etc/grub.d/
bash gengrub.sh | tee /etc/grub.d/11_lfs
chmod -v a+x /etc/grub.d/11_lfs
```

`11_lfs` is used here is to sort this file after the default `10_linux` file. This file includes all kernels with "lfs" in their name

### using the host's boot partition

on the *host* system:

```
ln -svf "$LFS/etc/grub.d/11_lfs" /etc/grub.d
cp -v /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
grub-mkconfig > /boot/grub/grub.cfg
```


### previous notes

Assuming `sda` is the drive with `/` or `/boot`

`grub-install /dev/sda`

had issue with the above, see [this](https://wiki.archlinux.org/index.php/GRUB#Install_to_partition_or_partitionless_disk)

```
chattr -i /boot/grub/i386-pc/core.img
grub-install --target=i386-pc --debug --force /dev/sda
chattr +i /boot/grub/i386-pc/core.img
```

Setup `grub.conf`. the kernel files are relative to the *partition* used, so remove `/boot`:

```
cat > /boot/grub/grub.cfg << "EOF"
set default=0
set timeout=5
insmod ext2
set root=(hd0,1)
menuentry "GNU/Linux, Linux 4.4.2-lfs-20160304-systemd" {
        linux   /vmlinuz-4.4.2-lfs-20160304-systemd root=/dev/sda2 ro
}
EOF
```
