# Making the system bootable

## fstab

from outside chroot, run `scripts/8/genfstab.sh`, and redirect to `$LFS/etc/fstab`

note: this gets the uuid (but does not work in chroot) and uses that build the fstab entries

## Linux

### setup

see `scripts/8/linux-setup.sh` to extract sources and clean, and setup a default config

### configure

Configure using the menu `make menuconfig`

see the note about required options!

(partial check: `scripts/8/check-kernel-config`)

### build

Time: 2.7x real (user+sys: 13.3x)

```
time make -j5
time make modules_install
```

### install

If installing on the host's `/boot`, you first need to bind mount it: `mount --bind /boot $LFS/boot` (todo: move this into chroot's mounting)

see `scripts/8/install-linux.sh`

todo: `modules_install` should probably move here

### No need to remove the sources

But need to chown: `chown -R 0:0 .`

## GRUB

`/boot/grub/grub.cfg` is generated by `grub-mkconfig`, so rather make changes there (`grub-mkconfig` is also installed in LFS, so not just always use that always)

Output `scripts/8/gengrub.sh` to `/etc/grub.d/11_lfs` and make it executable:

```
bash gengrub.sh | tee /etc/grub.d/11_lfs
chmod -v a+x /etc/grub.d/11_lfs
```

View this file and make sure it is correct. Consider using `UUID=...` instead of the disk name/number

### using the host's boot partition

You first need to bind mount the partition, before installing the kernal to it. Include `/boot` partition in `fstab`

on the *host* system:

```
ln -svf "$LFS/etc/grub.d/11_lfs" /etc/grub.d
cp -v /boot/grub/grub.cfg /boot/grub/grub.cfg.bak
grub-mkconfig > /boot/grub/grub.cfg
```


### previous notes

Assuming `sda` is the drive with `/` or `/boot`

`grub-install /dev/sda`

had issue with the above, see [this](https://wiki.archlinux.org/index.php/GRUB#Install_to_partition_or_partitionless_disk)

```
chattr -i /boot/grub/i386-pc/core.img
grub-install --target=i386-pc --debug --force /dev/sda
chattr +i /boot/grub/i386-pc/core.img
```

Setup `grub.conf`. the kernel files are relative to the *partition* used, so remove `/boot`:

```
cat > /boot/grub/grub.cfg << "EOF"
set default=0
set timeout=5
insmod ext2
set root=(hd0,1)
menuentry "GNU/Linux, Linux 4.4.2-lfs-20160304-systemd" {
        linux   /vmlinuz-4.4.2-lfs-20160304-systemd root=/dev/sda2 ro
}
EOF
```
